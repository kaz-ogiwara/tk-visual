function addCommas(e){return String(e).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,")}function renderLayer(){const e=function(e,t){let a=0;for(let n=0;n<e.length;n++)a+=e[n][t];return a/=e.length},t=function({x:e,y:t,object:a}){if(a){if(curIndex!==a.index){document.getElementById("tooltip-points").innerHTML="";for(let e=0;e<a.points.length;e++){let t=a.points[e],i=document.createElement("tr"),l=[2,3,4,5];for(let e=0;e<l.length;e++){let a=document.createElement("td"),o=t[l[e]];if(a.innerHTML=o,2===l[e]){var n=o,r=null;o.match(/・/)&&(n=o.substr(0,o.indexOf("・")),r=o.substr(o.indexOf("・")+1,99)),"en"===document.getElementsByTagName("body")[0].getAttribute("lang")?(r&&(a.innerHTML=r+"<span>m from </span>"+n),n.match(/（近接）/)&&(a.innerHTML="Close to "+n.replace("（近接）","")),n.match(/（接面）/)&&(a.innerHTML="Adjacent to "+n.replace("（接面）",""))):(o.match(/・/)&&(a.innerHTML=o.replace("・",'<span class="n">から</span>')+"<span>m</span>"),o.match(/（近接）/)&&(a.innerHTML=o.replace("（近接）","<span>（近接）</span>")),o.match(/（接面）/)&&(a.innerHTML=o.replace("（接面）","<span>（接面）</span>")))}if(3!==l[e]&&4!==l[e]||("en"===document.getElementsByTagName("body")[0].getAttribute("lang")?(3===l[e]&&"price"===curDataType&&(o=addCommas(parseInt(1e4*parseFloat(o)).toString())),3===l[e]&&"price"===curDataType&&(o+="<span>JPY/m²</span>"),3===l[e]&&"rate"===curDataType&&(o+="<span>%</span>")):(o=addCommas(o),3===l[e]&&"price"===curDataType&&(o+="<span>万円/m²</span>"),3===l[e]&&"rate"===curDataType&&(o+="<span>％</span>")),4===l[e]&&(o+="<span>m²</span>"),a.innerHTML=o,a.classList.add("right")),5===l[e]&&"en"===document.getElementsByTagName("body")[0].getAttribute("lang")){let e=t[8].charAt(0).toUpperCase()+t[8].slice(1);a.innerHTML=e}i.appendChild(a)}document.getElementById("tooltip-points").appendChild(i)}document.getElementById("tooltip").classList.add("show"),curIndex=a.index}}else document.getElementById("tooltip").classList.remove("show"),curIndex=-1},a=new deck.HexagonLayer({id:"heatmap",data:data,colorRange:COLORS,getColorValue:t=>e(t,7),elevationScale:"latest"===curDataType?20:15,getElevationValue:t=>e(t,6),extruded:!0,getPosition:e=>e,autoHighlight:!0,highlightColor:[240,220,0,230],lightSettings:LIGHT_SETTINGS,opacity:1,radius:200,coverage:1,pickable:!0,onHover:t,onClick:t,upperPercentile:100});deckgl.setProps({layers:[a]})}function loadData(){let e="en"===document.getElementsByTagName("body")[0].getAttribute("lang")?"data/data-en.csv":"data/data.csv";d3.csv(e,(e,t)=>{data=t.map(function(e){return("all"===curAreaType||e.areatype&&e.areatype==curAreaType)&&e.datatype==curDataType?[Number(e.longitude),Number(e.latitude),String(e.station),Number(e.value),String(e.area),String(e.purpose),Number(e.height),Number(e.color),String(e.areatype),String(e.datatype)]:[]}),renderLayer()})}const LAT=35.739,LNG=139.732;let data=null,curIndex=0,curDataType="price",curAreaType="all";const deckgl=new deck.DeckGL({mapboxApiAccessToken:"pk.eyJ1IjoidGtwZmFkbWluIiwiYSI6ImNqbjJ2c2pkazMzcnAzcW84d3dpbjR2NmQifQ.dxPtzKHbhxypqtj7aZ9E2w",mapStyle:"mapbox://styles/mapbox/dark-v9",longitude:LNG,latitude:LAT,zoom:10,minZoom:7,maxZoom:13,pitch:45,bearing:20}),getRGB=function(e){return 3==(e=e.slice(1)).length&&(e=e.slice(0,1)+e.slice(0,1)+e.slice(1,2)+e.slice(1,2)+e.slice(2,3)+e.slice(2,3)),[e.slice(0,2),e.slice(2,4),e.slice(4,6)].map(function(e){return parseInt(e,16)})},COLORS=[getRGB("#313695"),getRGB("#4575b4"),getRGB("#74add1"),getRGB("#abd9e9"),getRGB("#e0f3f8"),getRGB("#fee090"),getRGB("#fdae61"),getRGB("#f46d43"),getRGB("#d73027"),getRGB("#a50026")],LIGHT_SETTINGS={lightsPosition:[LNG+.2,LAT-.02,8e3,LNG-.2,35.759,8e3],ambientRatio:.4,diffuseRatio:.6,specularRatio:.2,lightsStrength:[.8,0,.8,0],numberOfLights:2};window.addEventListener("load",function(){let e=window.parent.document.getElementById("select-data"),t=window.parent.document.getElementById("select-area");e&&e.addEventListener("change",function(){curDataType=e.value,loadData()},!1),t&&t.addEventListener("change",function(){curAreaType=t.value,loadData()},!1)},!1),loadData();