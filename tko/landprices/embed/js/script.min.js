function addCommas(e){return String(e).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,")}function renderLayer(){const e=function(e,t){let a=0;for(let n=0;n<e.length;n++)a+=e[n][t];return a/=e.length},t=function({x:e,y:t,object:a}){if(a){if(curIndex!==a.index){document.getElementById("tooltip-points").innerHTML="";for(let e=0;e<a.points.length;e++){let t=a.points[e],n=document.createElement("tr"),i=[2,3,4,5];for(let e=0;e<i.length;e++){let a=document.createElement("td"),r=t[i[e]];a.innerHTML=r,2===i[e]&&(r.match(/・/)&&(a.innerHTML=r.replace("・",'<span class="n">から</span>')+"<span>m</span>"),r.match(/（近接）/)&&(a.innerHTML=r.replace("（近接）","<span>（近接）</span>")),r.match(/（接面）/)&&(a.innerHTML=r.replace("（接面）","<span>（接面）</span>"))),3!==i[e]&&4!==i[e]||(r=addCommas(r),3===i[e]&&"price"===curDataType&&(r+="<span>万円/m²</span>"),3===i[e]&&"rate"===curDataType&&(r+="<span>％</span>"),4===i[e]&&(r+="<span>m²</span>"),a.innerHTML=r,a.classList.add("right")),n.appendChild(a)}document.getElementById("tooltip-points").appendChild(n)}document.getElementById("tooltip").classList.add("show"),curIndex=a.index}}else document.getElementById("tooltip").classList.remove("show"),curIndex=-1},a=new deck.HexagonLayer({id:"heatmap",data:data,colorRange:COLORS,getColorValue:t=>e(t,7),elevationScale:"latest"===curDataType?20:15,getElevationValue:t=>e(t,6),extruded:!0,getPosition:e=>e,autoHighlight:!0,highlightColor:[240,220,0,230],lightSettings:LIGHT_SETTINGS,opacity:1,radius:200,coverage:1,pickable:!0,onHover:t,onClick:t,upperPercentile:100});deckgl.setProps({layers:[a]})}function loadData(){d3.csv("data/data.csv",(e,t)=>{data=t.map(function(e){return("all"===curAreaType||e.areatype&&e.areatype==curAreaType)&&e.datatype==curDataType?[Number(e.longitude),Number(e.latitude),String(e.station),Number(e.value),String(e.area),String(e.purpose),Number(e.height),Number(e.color),Number(e.areatype),Number(e.datatype)]:[]}),renderLayer()})}const LAT=35.739,LNG=139.732;let data=null,curIndex=0,curDataType="price",curAreaType="all";const deckgl=new deck.DeckGL({mapboxApiAccessToken:"pk.eyJ1IjoidGtwZmFkbWluIiwiYSI6ImNqbjJ2c2pkazMzcnAzcW84d3dpbjR2NmQifQ.dxPtzKHbhxypqtj7aZ9E2w",mapStyle:"mapbox://styles/mapbox/dark-v9",longitude:LNG,latitude:LAT,zoom:10,minZoom:7,maxZoom:13,pitch:45,bearing:20}),getRGB=function(e){return 3==(e=e.slice(1)).length&&(e=e.slice(0,1)+e.slice(0,1)+e.slice(1,2)+e.slice(1,2)+e.slice(2,3)+e.slice(2,3)),[e.slice(0,2),e.slice(2,4),e.slice(4,6)].map(function(e){return parseInt(e,16)})},COLORS=[getRGB("#313695"),getRGB("#4575b4"),getRGB("#74add1"),getRGB("#abd9e9"),getRGB("#e0f3f8"),getRGB("#fee090"),getRGB("#fdae61"),getRGB("#f46d43"),getRGB("#d73027"),getRGB("#a50026")],LIGHT_SETTINGS={lightsPosition:[LNG+.2,LAT-.02,8e3,LNG-.2,35.759,8e3],ambientRatio:.4,diffuseRatio:.6,specularRatio:.2,lightsStrength:[.8,0,.8,0],numberOfLights:2};window.addEventListener("load",function(){let e=window.parent.document.getElementById("select-data"),t=window.parent.document.getElementById("select-area");e&&e.addEventListener("change",function(){curDataType=e.value,loadData()},!1),t&&t.addEventListener("change",function(){curAreaType=t.value,loadData()},!1)},!1),loadData();