function addCommas(e){return String(e).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,")}function map(e,t,a,r,o){return r+(o-r)*(e-t)/(a-t)}function dottedLine(e,t,a,r){for(var o=dist(e,t,a,r)/150,n=1,l=gPercent=0,d=0,s=yy1=xx2=yy2=0;int(n*o)<1;)n++;for(l=n,n=1;int(n*o)<1;)n++;for(gPercent=n,l/=150,gPercent/=150;d<1;)s=lerp(e,a,d),yy1=lerp(t,r,d),xx2=lerp(e,a,d+l),yy2=lerp(t,r,d+l),e>a&&xx2<a&&(xx2=a),e<a&&xx2>a&&(xx2=a),t>r&&yy2<r&&(yy2=r),t<r&&yy2>r&&(yy2=r),line(s,yy1,xx2,yy2),d=d+l+gPercent}function preload(){imgLogo=loadImage("../../assets/img/logo-tko-white.png")}function setup(){createCanvas(kCanvas.w,kCanvas.h).parent("canvas"),pixelDensity(2),frameRate(0),textFont("Helvetica Neue, Arial, Noto Sans Japanese"),$.getJSON("data/data.json",function(e){kData=e,draw(),initMap()})}function draw(){background("#234"),drawTitle(),drawYears(),drawBaseLines(),drawValueLines(),drawLegend(),drawNotes(),drawLogo()}function drawNotes(){let e=kCanvas.h-4;textSize(9),textAlign(LEFT,BOTTOM),noStroke(),fill("#aaa"),text("出所：文部科学省「社会教育調査」。\n専任＋兼任＋非常勤に占める非常勤の割合。\n指定管理者の職員は含まない。\n調査周期は原則3年だが2015年度は1年延期された。",4,e)}function drawLogo(){image(imgLogo,kCanvas.w-848/6.5,kCanvas.h-320/6.5,848/6.5,320/6.5)}function drawTitle(){textSize(16),textAlign(LEFT,TOP),noStroke(),fill("#fafafa"),text("都道府県別「図書館司書」の非正規雇用",4,4)}function gotoBlock(e){let t=$("#"+e+"-block"),a=$("#map-block").find(".navigation");"map"===e&&(a=$("#canvas-block").find(".navigation"));let r=!1;a.hasClass("show")&&(r=!0,a.removeClass("show"));let o=r&&"canvas"===e?400:0,n=r?1200:600,l=t.offset().top-24;setTimeout(function(){$("html, body").animate({scrollTop:l},n,"swing")},o),updateDataTable()}function updateDataTable(){let e=selectedPrefCode||"48",t=$(".touch-area").index($(".selected")),a=kData[e][t];$("#dt-year").text(kYears[t]),$("#dt-pref").text(getPrefName(e)),$("#dt-m-f").text(addCommas(a.M[0])),$("#dt-m-a").text(addCommas(a.M[1])),$("#dt-m-p").text(addCommas(a.M[2])),$("#dt-m-t").text(addCommas(a.M[0]+a.M[1]+a.M[2])),$("#dt-m-r").text((a.M[2]/(a.M[0]+a.M[1]+a.M[2])*100).toFixed(1)+"%"),$("#dt-f-f").text(addCommas(a.F[0])),$("#dt-f-a").text(addCommas(a.F[1])),$("#dt-f-p").text(addCommas(a.F[2])),$("#dt-f-t").text(addCommas(a.F[0]+a.F[1]+a.F[2])),$("#dt-f-r").text((a.F[2]/(a.F[0]+a.F[1]+a.F[2])*100).toFixed(1)+"%"),$("#dt-t-f").text(addCommas(a.F[0]+a.M[0])),$("#dt-t-a").text(addCommas(a.F[1]+a.M[1])),$("#dt-t-p").text(addCommas(a.F[2]+a.M[2])),$("#dt-t-t").text(addCommas(a.F[0]+a.F[1]+a.F[2]+a.M[0]+a.M[1]+a.M[2])),$("#dt-t-r").text(((a.M[2]+a.F[2])/(a.M[0]+a.M[1]+a.M[2]+a.F[0]+a.F[1]+a.F[2])*100).toFixed(1)+"%")}function getValue(e){let t=e.F[0]+e.F[1]+e.F[2]+e.M[0]+e.M[1]+e.M[2];return((e.F[2]+e.M[2])/t*100).toFixed(1)}function setPreferences(e){"text-legend"===e?(noStroke(),fill("#fafafa"),textSize(13),textAlign(LEFT,BOTTOM)):"line-average"===e?(noFill(),strokeWeight(4),stroke(color(kColors.lineAverage))):"line-selectedPref"===e?(noFill(),strokeWeight(4),stroke(color(kColors.lineSelectedPref))):"line-otherPref"===e&&(noFill(),strokeWeight(1),stroke(color(kColors.lineOtherPref)))}function drawLegend(){let e=kChart.x+kChart.w-108,t=kChart.y+kChart.h-12,a=t-20,r=a-20;setPreferences("text-legend"),text("その他の都道府県",e,t),text("全国",e,a),setPreferences("line-otherPref"),line(e-20,t-6,e-8,t-6),setPreferences("line-average"),line(e-20,a-6,e-8,a-6),selectedPrefCode&&(setPreferences("text-legend"),text(getPrefName(selectedPrefCode),e,r),setPreferences("line-selectedPref"),line(e-20,r-6,e-8,r-6))}function getColor(e){let t=parseInt(e/10);return kColors.map[t]}function drawValueLines(){for(code in kData)drawValueLine(code,"other");drawValueLine("48","average"),selectedPrefCode&&drawValueLine(selectedPrefCode,"selected")}function drawValueLine(e,t){let a=0;beginShape(),kData[e].forEach(function(e){let r=getValue(e),o=kChart.x+a*(kChart.w/(kYears.length-1)),n=map(r,VALUE_MIN,VALUE_MAX,kChart.y+kChart.h,kChart.y);"other"===t&&setPreferences("line-otherPref"),"average"===t&&setPreferences("line-average"),"selected"===t&&setPreferences("line-selectedPref"),vertex(o,n),a++}),endShape()}function drawYears(){for(let e=0;e<kYears.length;e++){let t=map(e,0,kYears.length-1,0,kChart.w)+kChart.x,a=kChart.y+kChart.h;noFill(),strokeWeight(1),stroke("#eee"),line(t,a-8,t,a+8),noStroke(),fill("#ddd"),textSize(12),textAlign(CENTER,TOP),0===e&&(t+=12),e===kYears.length-1&&(t-=11),text(kYears[e],t,a+16)}}function drawBaseLines(){strokeWeight(2),stroke(255,200),noFill(),line(kChart.x,kChart.y+kChart.h,kChart.x+kChart.w,kChart.y+kChart.h);for(let e=0;e<=VERTICAL_NUM;e++){let t=map(e,0,VERTICAL_NUM,kChart.y,kChart.y+kChart.h);strokeWeight(1),stroke(255,60),dottedLine(kChart.x,t,kChart.x+kChart.w,t),noStroke(),fill(255,200),textAlign(RIGHT,CENTER),textSize(14),text(VALUE_MAX-20*e,kChart.x-15,t),fill(255,100),textSize(11),text("%",kChart.x-2,t+1)}}function getPrefName(e){return["北海道","青森県","岩手県","宮城県","秋田県","山形県","福島県","茨城県","栃木県","群馬県","埼玉県","千葉県","東京都","神奈川県","新潟県","富山県","石川県","福井県","山梨県","長野県","岐阜県","静岡県","愛知県","三重県","滋賀県","京都府","大阪府","兵庫県","奈良県","和歌山県","鳥取県","島根県","岡山県","広島県","山口県","徳島県","香川県","愛媛県","高知県","福岡県","佐賀県","長崎県","熊本県","大分県","宮崎県","鹿児島県","沖縄県","全国"][parseInt(e)-1]}function initMap(){const e=$("#map").width(),t=$("#map").height();let a=d3.geoMercator().center([137,36]).scale(1e3).translate([.5*e,.5*t]),r=d3.geoPath().projection(a),o=d3.select("#map").attr("width",e).attr("height",t);d3.json("../../assets/topojson/001/prefectures.topojson").then(function(e){let t=o.selectAll("path").data(topojson.feature(e,e.objects["-"]).features).enter().append("path").attr("fill","rgb(255, 255, 255)").attr("stroke","rgba(255, 255, 255,0.1)").attr("stroke-width","0.1").attr("d",r).attr("class","pref").on("click tap touch",function(e,t){let a=e.properties.iso_3166_2.replace("JP-","");selectedPrefCode=a,updateMapColors(),draw(),d3.select(this).attr("fill","yellow"),gotoBlock("canvas")});$(".touch-area").eq(5).addClass("selected"),updateMapColors(),updateDataTable();let n=d3.drag().on("drag",function(){let e=a.translate();a.translate([e[0]+d3.event.dx,e[1]+d3.event.dy]),t.attr("d",r)}),l=d3.zoom().on("zoom",function(){t.attr("transform",d3.event.transform)});o.call(n),o.call(l)}),$legend=$("#map-legend");let n=0;kColors.map.forEach(function(e){let t='<li><div class="circle" style="background-color:'+e+';"></div>'+((10*n).toString()+"% - "+(10*(n+1)).toString()+"%")+"</li>";$legend.prepend(t),n++})}function updateMapColors(){let e=$(".touch-area").index($(".selected"));d3.select("#map").selectAll("path").attr("fill",function(t,a){let r=t.properties.iso_3166_2.replace("JP-","");return getColor(getValue(kData[r][e]))}),$("#map-year-num").text(kYears[e])}let kData,imgLogo,kCanvas={w:$("#canvas").width(),h:$("#canvas").height()},kChart={x:36,y:50,w:kCanvas.w-44,h:kCanvas.h-140},kColors={lineAverage:"#fff3cd",lineSelectedPref:"#FFAA92",lineOtherPref:[100,250,200,90],map:"#C7FFD2,#FFE9E0,#FFEEE9,#FFD9CF,#FFC0AE,#FFAA92,#FF9274,#EC7555,#EC2267".split(",")},MIN_YEAR=1999,VERTICAL_NUM=4,VALUE_MIN=0,VALUE_MAX=80,selectedPrefCode=null,kYears=["1999","2002","2005","2008","2011","2015"];$(function(){$(".touch-area").on("click",function(){$(".touch-area").removeClass("selected"),$(this).addClass("selected"),draw(),updateMapColors(),gotoBlock("map")}),$(document).on("click",function(e){$(e.target).closest(".pref").length||$(e.target).closest("#canvas").length||$(e.target).closest("#button-download-image").length||(selectedPrefCode=null,draw(),updateMapColors(),updateDataTable())}),$("#button-download-image").on("click",function(){saveCanvas("toyokeizai-online","png")})});