function getRGB(t){return 3==(t=t.slice(1)).length&&(t=t.slice(0,1)+t.slice(0,1)+t.slice(1,2)+t.slice(1,2)+t.slice(2,3)+t.slice(2,3)),[t.slice(0,2),t.slice(2,4),t.slice(4,6)].map(function(t){return parseInt(t,16)})}function addCommas(t){return String(t).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,")}function getRateString(t){let e=(100*t).toFixed(1)+"%";return e=t<0?'<span class="minus">'+e+"</span>":'<span class="plus">+'+e+"</span>"}function getAverageString(t,e){return(t/e/1e4).toFixed(1)+"<span>万円/m²</span>"}function rotateViewport(t){let e=deckgl.controller.props.viewState;"right"===t&&(e.bearing-=9),"left"===t&&(e.bearing+=9),"up"===t&&(e.pitch-=6),"down"===t&&(e.pitch+=6),e.pitch<0&&(e.pitch=0),e.pitch>60&&(e.pitch=60),deckgl.setProps({viewState:{longitude:e.longitude,latitude:e.latitude,zoom:e.zoom,minZoom:e.minZoom,maxZoom:e.maxZoom,pitch:e.pitch,bearing:e.bearing}})}function getElevationScale(){return"latest"===curDataType?300:20}function getMinMax(t){let e={latest:{minStation:"",maxStation:"",minValue:null,maxValue:null},past:{minStation:"",maxStation:"",minValue:null,maxValue:null}};for(let a=0;a<t.length;a++)if("all"===curAreaType||curAreaType===t[a][2]){t[a][3]&&((null===e.latest.minValue||e.latest.minValue>t[a][3])&&(e.latest.minValue=t[a][3],e.latest.minStation=t[a][8]),(null===e.latest.maxValue||e.latest.maxValue<t[a][3])&&(e.latest.maxValue=t[a][3],e.latest.maxStation=t[a][8]));let n;"rate18"===curDataType&&(n=t[a][4]),"rate09"===curDataType&&(n=t[a][5]),"rate99"===curDataType&&(n=t[a][6]),"rate89"===curDataType&&(n=t[a][7]),n&&((null===e.past.minValue||e.past.minValue>n)&&(e.past.minValue=n,e.past.minStation=t[a][8]),(null===e.past.maxValue||e.past.maxValue<n)&&(e.past.maxValue=n,e.past.maxStation=t[a][8]))}return e}function getStation(t){let e="",a=t.indexOf("、");if(a<0)e=t;else{let n=t.slice(a+1);n.slice(-1).match(/[0-9]/g)&&(n+="m"),e=t.substring(0,a)+"<span>（"+n+"）</span>"}return e}function getStringBefore(t,e){let a="",n=t.indexOf(e);return a=n<0?t:t.substring(0,n)}function getAverage(t,e){let a,n,i=0,r=0,l=0,o=0,s=getMinMax(t);for(let e=0;e<t.length;e++)if("all"===curAreaType||curAreaType===t[e][2]){t[e][3]&&(i+=t[e][3],l+=1);let a;"rate18"===curDataType&&(a=t[e][4]),"rate09"===curDataType&&(a=t[e][5]),"rate99"===curDataType&&(a=t[e][6]),"rate89"===curDataType&&(a=t[e][7]),a&&(r+=a,o+=1)}return"latest"===curDataType?0!==l&&(a=i/l):0!==l&&0!==o&&(a=i/l/(r/o)-1),void 0===a?null:("latest"===curDataType?"color"===e?(a<=19e3&&(n=1),a>=19e3&&(n=2),a>=29600&&(n=3),a>=41e3&&(n=4),a>=55700&&(n=5),a>=73400&&(n=6),a>=99200&&(n=7),a>=137e3&&(n=8),a>=197e3&&(n=9),a>=333e3&&(n=10)):"elevation"===e?n=a:"tooltip"===e&&(n="<tr><th>平均値</th><td>"+getAverageString(i,l)+'</td><td class="right">'+l+"<span>地点</span></td></tr><tr><th>最高値</th><td>"+getStation(s.latest.maxStation)+'</td><td class="right">'+getAverageString(s.latest.maxValue,1)+"</td></tr><tr><th>最安値</th><td>"+getStation(s.latest.minStation)+'</td><td class="right">'+getAverageString(s.latest.minValue,1)+"</td></tr>"):"color"===e?(a<=-.4&&(n=1),a>=-.3&&(n=2),a>=-.2&&(n=3),a>=-.1&&(n=4),a>=-.05&&(n=5),a>=0&&(n=6),a>=.05&&(n=7),a>=.1&&(n=8),a>=.2&&(n=9),a>=.3&&(n=10)):"elevation"===e?n=Math.abs(a):"tooltip"===e&&(n="<tr><td><span>平均</span> "+getAverageString(i,l)+"</td><td><span>平均</span> "+getAverageString(r,o)+"</td><td>"+getRateString(a)+"</td></tr><tr><td>"+getStringBefore(s.latest.maxStation,"、")+"<span> など </span>"+l+"<span> 件</span></td><td>"+getStringBefore(s.past.maxStation,"、")+"<span> など </span>"+o+"<span> 件</span></td><td></td></tr>"),n)}function hideTooltip(){document.getElementById("tooltip").classList.remove("show"),curIndex=-1}function showTooltip({x:t,y:e,object:a}){if(a){if(curIndex!==a.index){let t=$("#tooltip-head"),e=$("#tooltip-body");t.empty(),e.empty();getMinMax(a.points);if("latest"===curDataType);else{let e="";"rate18"===curDataType&&(e="2018"),"rate09"===curDataType&&(e="2009"),"rate99"===curDataType&&(e="1999"),"rate89"===curDataType&&(e="1989"),t.append("<tr><th>2019年</th><th>"+e+"年</th><th>騰落率</th></tr>")}e.append(getAverage(a.points,"tooltip")),$("#tooltip").addClass("show"),curIndex=a.index}}else hideTooltip()}function renderLayer(){const t=new deck.HexagonLayer({id:"heatmap",data:data,colorRange:COLORS,getColorValue:t=>getAverage(t,"color"),elevationScale:getElevationScale(),getElevationValue:t=>getAverage(t,"elevation"),extruded:!0,getPosition:t=>t,autoHighlight:!0,highlightColor:[240,220,0,230],lightSettings:LIGHT_SETTINGS,opacity:1,radius:2e3,coverage:1,pickable:!0,onHover:showTooltip,onClick:showTooltip,upperPercentile:100});deckgl.setProps({layers:[t]})}function loadData(){let t=["、20","、40"];d3.csv("data/data.csv",(e,a)=>{data=a.map(function(e){return-1===t.indexOf(String(e.station).slice(-3))?[Number(e.longitude),Number(e.latitude),String(e.landtype),Number(e.price19),Number(e.price18),Number(e.price09),Number(e.price99),Number(e.price89),String(e.station),String(e.size),String(e.usage)]:[]}),renderLayer()})}const LAT=35.8,LNG=138.7;let data=null,curIndex=0,curDataType="latest",curAreaType="all";const COLORS=[getRGB("#313695"),getRGB("#4575b4"),getRGB("#74add1"),getRGB("#abd9e9"),getRGB("#e0f3f8"),getRGB("#fee090"),getRGB("#fdae61"),getRGB("#f46d43"),getRGB("#d73027"),getRGB("#a50026")],LIGHT_SETTINGS={lightsPosition:[140.7,33.8,2e3,136.7,37.8,2e3],ambientRatio:.4,diffuseRatio:.6,specularRatio:.2,lightsStrength:[1.3,.4,1.3,.4],numberOfLights:2},deckgl=new deck.DeckGL({mapboxApiAccessToken:"pk.eyJ1IjoidGtwZmFkbWluIiwiYSI6ImNqbjJ2c2pkazMzcnAzcW84d3dpbjR2NmQifQ.dxPtzKHbhxypqtj7aZ9E2w",mapStyle:"mapbox://styles/mapbox/dark-v9",longitude:LNG,latitude:LAT,zoom:6,minZoom:5,maxZoom:11,pitch:40,bearing:-10});$(function(){loadData(),$(parent.document).find("select").on("change",function(){"select-data"===$(this).attr("id")?curDataType=$(this).val():curAreaType=$(this).val(),renderLayer()}),$("#buttons").find("button").on("click",function(){rotateViewport($(this).attr("type"))})});