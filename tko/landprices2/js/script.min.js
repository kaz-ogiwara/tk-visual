function addCommas(t){return String(t).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,")}function drawMap(){for(let t=1;t<=47;t++)addPrefecture(t);$("body").hasClass("en")&&d3.json("data/names_en.json",function(t,e){if(t)throw t;kNamesE=e})}function setLayerColor(){curTarget=null,curColor=null,highlightEvent=null,d3.json("data/c"+$("#select-year").val()+".json",function(t,e){if(t)throw t;kData=e,geojsonLayers.forEach(function(t){t.setStyle(fillStyle)})})}function loadMain(){d3.json("data/main.json",function(t,e){if(t)throw t;kMain=e})}function highlightFeature(t){resetHighlight();var e=t.target;let o=e.feature.properties,a=o.N03_001;null!=o.N03_003&&(a=a+" "+o.N03_003),null!=o.N03_004&&(a=a+" "+o.N03_004);let n=o.N03_007;kData.forEach(function(o){if(o[0]==n){let s=["","",""],l=["","",""],r=["","",""],i=["","",""];curColor=getValueColor(o[6]);for(let t=0;t<=2;t++)""!==o[t+1]&&(s[t]=o[t+4].toString(),o[t+4]>0&&(s[t]="+"+s[t]),""!==s[t]&&(s[t]=s[t]+"<span>％</span>"),r[t]=addCommas(o[t+1].toString()),i[t]="","+"===s[t].slice(0,1)&&(i[t]=" plus"),"-"===s[t].slice(0,1)&&(i[t]=" minus"));let c=$("body").hasClass("en")?"":"年",d=$("body").hasClass("en")?"JPY / m<sup>2</sup>":"円/㎡",u=$("body").hasClass("en")?"Residence:":"住宅地：",h=$("body").hasClass("en")?"Business:":"商業地：",f=$("body").hasClass("en")?"Overall:":"全用途：";kMain&&kMain.forEach(function(t){t[0]==n&&(l[0]=addCommas(t[1])+"<span>"+d+"</span>",l[1]=addCommas(t[2])+"<span>"+d+"</span>",l[2]=addCommas(t[3])+"<span>"+d+"</span>")}),kNamesE&&kNamesE[n]&&(a=kNamesE[n]);let g='<div id="title">'+a+"</div><table><tr><th></th><th>2018"+c+"</th><th>"+$("#select-year").val()+c+"</th><th></th></tr><tr><td>"+u+'</td><td class="price">'+l[0]+'</td><td class="price">'+r[0]+"<span>"+d+'</span></td><td class="value'+i[0]+'">'+s[0]+"</td></tr><tr><td>"+h+'</td><td class="price">'+l[1]+'</td><td class="price">'+r[1]+"<span>"+d+'</span></td><td class="value'+i[1]+'">'+s[1]+"</td></tr><tr><td>"+f+'</td><td class="price">'+l[2]+'</td><td class="price">'+r[2]+"<span>"+d+'</span></td><td class="value'+i[2]+'">'+s[2]+"</td></tr></table>";$("#tooltip").html(g),$("#tooltip").addClass("show"),e.setStyle({fillColor:"#eeee33"}),L.Browser.ie||L.Browser.opera||L.Browser.edge||e.bringToFront(),curTarget=t.target,highlightEvent=null}})}function resetHighlight(){curTarget&&curTarget.setStyle({fillColor:curColor}),$("#tooltip").removeClass("show")}function getValueColor(t){let e="#aaa",o="#CE5A2D,#FF8455,#FF9972,#FFAE8F,#FFC3AB,#FFD7C8".split(","),a="#1B5467,#3988A3,#529FB9,#65A6BC,#8AC6DA,#B9EDFF".split(",");return t<=-40&&(e=a[0]),-40<=t&&t<=-30&&(e=a[1]),-30<=t&&t<=-20&&(e=a[2]),-20<=t&&t<=-10&&(e=a[3]),-10<=t&&t<=-5&&(e=a[4]),-5<=t&&t<=-1&&(e=a[5]),-1<=t&&t<=1&&(e="#fafafa"),1<=t&&t<=5&&(e=o[5]),5<=t&&t<=10&&(e=o[4]),10<=t&&t<=20&&(e=o[3]),20<=t&&t<=30&&(e=o[2]),30<=t&&t<=40&&(e=o[1]),40<=t&&(e=o[0]),""===t&&(e="#ccc"),e}function fillStyle(t,e){let o=t.properties.N03_007,a="#aaa";return kData.forEach(function(t){t[0]==o&&(a=getValueColor(t[6]))}),{fillColor:a}}function defaultStyle(t,e){return{dashArray:"",fillColor:"#aaa",fillOpacity:1,color:"#ccc",weight:.2}}function setHighlight(t){highlightEvent=t}function onEachFeature(t,e){e.on({mouseover:highlightFeature,mouseout:resetHighlight,preclick:setHighlight})}function addPrefecture(t){let e=t.toString();t<=9&&(e="0"+e),d3.json("../../assets/topojson/001/p"+e+".topojson",function(e,o){if(e)throw e;geojsonLayers[t-1]=L.geoJson(topojson.feature(o,o.objects.prefecture),{style:defaultStyle,onEachFeature:onEachFeature}),geojsonLayers[t-1].addTo(kMap),47===++kDoneCount&&$.when(setLayerColor(),kDoneCount=0).then(function(){$("#map-cover").removeClass("show")})})}var kMap,kData,kMain,kNamesE,curTarget,curColor,highlightEvent,geojsonLayers=[],kDoneCount=0;$(function(){$(document).on("change","select",function(){setLayerColor()}),$(document).on("click","#fullscreen",function(t){$.when($("#cover").fadeIn("fast")).done(function(){$.when($("body").addClass("fullscreen"),kMap.invalidateSize()).done(function(){$("#cover").fadeOut("fast")})})}),$(document).on("click","body",function(t){highlightEvent?highlightFeature(highlightEvent):resetHighlight()}),$(document).on("click","#button-close",function(t){t.stopPropagation(),$.when($("#cover").fadeIn("fast")).done(function(){$.when($("body").removeClass("fullscreen")).done(function(){$("#cover").fadeOut("fast")})})}),kMap=new L.Map("map",{center:new L.LatLng(35.7,139.7),maxZoom:11,minZoom:5,zoom:7}),drawMap(),loadMain()});