function addCommas(t){return String(t).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,")}function drawMap(){for(let t=1;t<=47;t++)addPrefecture(t)}function setLayerColor(){curTarget=null,curColor=null,highlightEvent=null,d3.json("data/c"+$("#select-year").val()+".json",function(t,e){if(t)throw t;kData=e,geojsonLayers.forEach(function(t){t.setStyle(fillStyle)})})}function loadMain(){d3.json("data/main.json",function(t,e){if(t)throw t;kMain=e})}function highlightFeature(t){resetHighlight();var e=t.target;let o=e.feature.properties,n=o.N03_001,a="";null!=o.N03_003&&(a=a+" "+o.N03_003),null!=o.N03_004&&(a=a+" "+o.N03_004),a.slice(1);let l=o.N03_007;kData.forEach(function(o){if(o[0]==l){let r=["","",""],i=["","",""],s=["","",""],c=["","",""];curColor=getValueColor(o[6]);for(let t=0;t<=2;t++)""!==o[t+1]&&(r[t]=o[t+4].toString(),o[t+4]>0&&(r[t]="+"+r[t]),""!==r[t]&&(r[t]=r[t]+"<span>％</span>"),s[t]=addCommas(o[t+1].toString()),c[t]="","+"===r[t].slice(0,1)&&(c[t]=" plus"),"-"===r[t].slice(0,1)&&(c[t]=" minus"));kMain&&kMain.forEach(function(t){t[0]==l&&(i[0]=addCommas(t[1])+"<span>円/㎡</span>",i[1]=addCommas(t[2])+"<span>円/㎡</span>",i[2]=addCommas(t[3])+"<span>円/㎡</span>")});let u='<div id="title">'+n+" "+a+"</div><table><tr><th></th><th>2018年</th><th>"+$("#select-year").val()+'年</th><th></th></tr><tr><td>住宅地：</td><td class="price">'+i[0]+'</td><td class="price">'+s[0]+'<span>円/㎡</span></td><td class="value'+c[0]+'">'+r[0]+'</td></tr><tr><td>商業地：</td><td class="price">'+i[1]+'</td><td class="price">'+s[1]+'<span>円/㎡</span></td><td class="value'+c[1]+'">'+r[1]+'</td></tr><tr><td>全用途：</td><td class="price">'+i[2]+'</td><td class="price">'+s[2]+'<span>円/㎡</span></td><td class="value'+c[2]+'">'+r[2]+"</td></tr></table>";$("#tooltip").html(u),$("#tooltip").addClass("show"),e.setStyle({fillColor:"#eeee33"}),L.Browser.ie||L.Browser.opera||L.Browser.edge||e.bringToFront(),curTarget=t.target,highlightEvent=null}})}function resetHighlight(){curTarget&&curTarget.setStyle({fillColor:curColor}),$("#tooltip").removeClass("show")}function getValueColor(t){let e="#aaa",o="#CE5A2D,#FF8455,#FF9972,#FFAE8F,#FFC3AB,#FFD7C8".split(","),n="#1B5467,#3988A3,#529FB9,#65A6BC,#8AC6DA,#B9EDFF".split(",");return t<=-40&&(e=n[0]),-40<=t&&t<=-30&&(e=n[1]),-30<=t&&t<=-20&&(e=n[2]),-20<=t&&t<=-10&&(e=n[3]),-10<=t&&t<=-5&&(e=n[4]),-5<=t&&t<=-1&&(e=n[5]),-1<=t&&t<=1&&(e="#fafafa"),1<=t&&t<=5&&(e=o[5]),5<=t&&t<=10&&(e=o[4]),10<=t&&t<=20&&(e=o[3]),20<=t&&t<=30&&(e=o[2]),30<=t&&t<=40&&(e=o[1]),40<=t&&(e=o[0]),""===t&&(e="#ccc"),e}function fillStyle(t,e){let o=t.properties.N03_007,n="#aaa";return kData.forEach(function(t){t[0]==o&&(n=getValueColor(t[6]))}),{fillColor:n}}function defaultStyle(t,e){return{dashArray:"",fillColor:"#aaa",fillOpacity:1,color:"#ccc",weight:.2}}function setHighlight(t){highlightEvent=t}function onEachFeature(t,e){e.on({mouseover:highlightFeature,mouseout:resetHighlight,preclick:setHighlight})}function addPrefecture(t){let e=t.toString();t<=9&&(e="0"+e),d3.json("../../assets/topojson/001/p"+e+".topojson",function(e,o){if(e)throw e;geojsonLayers[t-1]=L.geoJson(topojson.feature(o,o.objects.prefecture),{style:defaultStyle,onEachFeature:onEachFeature}),geojsonLayers[t-1].addTo(kMap),47===++kDoneCount&&$.when(setLayerColor(),kDoneCount=0).then(function(){$("#map-cover").removeClass("show")})})}var kMap,kData,kMain,curTarget,curColor,highlightEvent,geojsonLayers=[],kDoneCount=0;$(function(){$(document).on("change","select",function(){setLayerColor()}),$(document).on("click","#fullscreen",function(t){$.when($("#cover").fadeIn("fast")).done(function(){$.when($("body").addClass("fullscreen"),kMap.invalidateSize()).done(function(){$("#cover").fadeOut("fast")})})}),$(document).on("click","body",function(t){highlightEvent?highlightFeature(highlightEvent):resetHighlight()}),$(document).on("click","#button-close",function(t){t.stopPropagation(),$.when($("#cover").fadeIn("fast")).done(function(){$.when($("body").removeClass("fullscreen")).done(function(){$("#cover").fadeOut("fast")})})}),kMap=new L.Map("map",{center:new L.LatLng(35.7,139.7),maxZoom:11,minZoom:5,zoom:7}),drawMap(),loadMain()});